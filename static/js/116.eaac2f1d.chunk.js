"use strict";(globalThis.webpackChunkjira_assistant=globalThis.webpackChunkjira_assistant||[]).push([[116],{7359:(e,t,s)=>{s.d(t,{A:()=>h});s(9950);var o=s(7426),r=s(847),i=s.n(r),l=s(787),a=s(8874),n=s(5674),c=s(4414);class d extends o.Ay{constructor(e,t,s){super(e,`Bulk import - [${t}]`,s),this.fileSelected=()=>{const e=this.fileSelector,t=e.files[0];if(t){if(!t.name.endsWith(".csv"))return this.$message.warning("Unknown file selected to import. Select a valid file to import"),void(e.value="");i().parse(t,{header:!0,transformHeader:this.transformHeader,skipEmptyLines:"greedy",complete:e=>{const{data:t}=e;t&&t.length||this.$message.warning("No rows found to import","No records exists"),this.processData(t)}})}e.value=""},this.getTicketLink=e=>(0,c.jsx)(n.A,{className:"link",href:this.$userutils.getTicketUrl(e),children:e}),this.setFileSelector=e=>this.fileSelector=e,this.chooseFileForImport=()=>this.fileSelector.click(),(0,a.WQ)(this,"UserUtilsService"),this.isGadget=!1,this.hideRefresh=!0}formatDate(e){return e instanceof Date?this.$userutils.formatDateTime(e):e}renderCustomActions(){return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("input",{ref:this.setFileSelector,type:"file",className:"hide",accept:".csv,.json, .xlsx",onChange:this.fileSelected}),(0,c.jsx)(l.$n,{text:!0,icon:"fa fa-upload",onClick:this.chooseFileForImport,title:"Choose file to import"})]})}}const h=d},6116:(e,t,s)=>{s.r(t),s.d(t,{default:()=>S});s(9950);var o=s(1427),r=s(7359),i=s(8874),l=s(787),a=s(1219),n=s(5674),c=s(4414);const d="Will Import",h="Error",m="Excluded",g="ticketNo",u="startDate",p="timespent",k="comment",f={ticketno:g,ticket:g,issuekey:g,issue:g,key:g,id:g,startdate:u,started:u,logdate:u,loggeddate:u,worklogdate:u,date:u,timespent:p,timespentseconds:p,seconds:p,hoursspent:p,time:p,spent:p,comment:k,comments:k,description:k,details:k};class x extends r.A{constructor(e){super(e,"Worklog","fa fa-clock"),this.transformHeader=e=>e&&"string"===typeof e&&f[e.replace(/[ "]/g,"").toLowerCase()]||null,this.importWorklogs=()=>{const{autoUpload:e,worklogData:t}=this.state,s=t.filter((e=>e.selected));if(e)this.uploadSelectedWorklogs(s);else{const e=s.map((e=>{e.selected=!1,e.disabled=!0;const{ticketNo:t,startDate:s,timespent:o,comment:r}=e,i=Math.floor(o/3600),l=Math.floor(o%3600/60),a={ticketNo:t,dateStarted:s,timeSpent:`${i.pad(2)}:${l.pad(2)}`,description:r};return this.$worklog.saveWorklog(a).then((t=>{e.id=t.id,e.status="Imported. Not Uploaded"}),(t=>{e.status=h,e.error=t}))}));Promise.all(e).then((()=>{this.$message.info("Worklog import completed. Upload it to Jira from Calendar or Worklog gadget."),this.setState({worklogData:[...t],selectedCount:""})}))}},this.toggleAllRows=()=>{let{selectAll:e,worklogData:t}=this.state;if(!t)return;e=!e;const s=e?d:m;t=[...t],t.forEach((t=>{t.disabled||(t.selected=e,t.status=s)})),this.setState({selectAll:e,worklogData:t,selectedCount:this.getSelectedLogs(t).length||""})},this.getSelectedLogs=e=>(e||this.state.worklogData).filter((e=>e.selected)),this.toggleAutoUpload=e=>this.setState({autoUpload:e}),this.toggleSelection=(e,t)=>{let{worklogData:s}=this.state;s=[...s],e.selected=!e.selected,e.status=e.selected?d:m,this.setState({worklogData:s,selectedCount:this.getSelectedLogs(s).length||""})},this.downloadTemplate=()=>{const e=(new Date).format("dd-MMM-yyyy HH:mm:ss"),t=["Ticket No,Start Date,Timespent,Comment",`JA-1001,${e},1w 2d 3h 4m,Logs 59 hours and 4 mins`,`JA-1001,${e},1d 1h,Logs 9 hours`,`JA-1002,${e},12.5,Logs 12 hours and 30 mins`,`JA-1003,${e},14:4,Logs 14 hours and 40 mins`,`JA-1003,${e},8,Logs 8 hours`];(0,a.z9)(t.join("\n"),"sample_worklog")},this.clearWorklogs=()=>{this.$q.reset(),this.setState({isLoading:!1,selectedCount:"",worklogData:null,ticketSummary:{},selectAll:!1})},(0,i.WQ)(this,"UtilsService","UserUtilsService","TicketService","QueueService","WorklogService","SessionService","MessageService"),this.maxHrsToLog=this.$session.CurrentUser.maxHours;const t=this.$session.CurrentUser.autoUpload||!1;this.state={autoUpload:t,ticketSummary:{},selectedCount:""},this.$q.on("completed",(()=>{this.$message.info("Worklog upload completed"),this.setState({isLoading:!1,selectedCount:""})}))}processData(e){const t=e.map((e=>{let{ticketNo:t="",startDate:s="",timespent:o="",comment:r=""}=e;t=t.trim(),s=s.trim(),o=o.trim(),r=r.trim();let i=!0,l=!1,n=d,c="";const h=e=>{i=!1,l=!0,n="Invalid",c?c+=`;${e}`:c=e};if(t||h("Ticket No is required"),s){const e=this.$utils.convertDate(s);e instanceof Date?s=e:h("Log Date is invalid")}else h("Log Date is required");if(o){const e=(0,a.t1)(o);e>0?o=e:h("Timespent is invalid")}else h("Timespent is required");return{selected:i,disabled:l,status:n,error:c,ticketNo:t,startDate:s,timespent:o,comment:r}})),s=this.getSelectedLogs(t),o=s.map((e=>e.ticketNo)).distinct();this.$ticket.getTicketDetails(o,!0).then((e=>{const t=e.reduce(((e,t)=>{const{key:s,fields:{summary:o,assignee:r,issuetype:{iconUrl:i,name:l}={}}}=t,{displayName:a}=r||{};return e[s]={summary:o,assignee:a,issueTypeIcon:i,issueType:l},e}),{});this.setState({ticketSummary:t})}));const r=o.reduce(((e,t)=>(e[t]={summary:"Loading..."},e)),{});this.setState({worklogData:t,ticketSummary:r,selectAll:!0,selectedCount:s.length||""})}uploadSelectedWorklogs(e){e.groupBy((e=>e.ticketNo)).forEach((e=>{this.$q.add((()=>{const t=e.values;return 1===t.length?this.uploadWorklog(t[0]):t.reduce((async(e,t)=>(await e,this.uploadWorklog(t))),Promise.resolve())}))})),this.$q.start()}uploadWorklog(e){const{ticketNo:t,startDate:s,timespent:o,comment:r}=e;e.status="Uploading...",this.setState((({worklogData:e})=>({worklogData:[...e]})));return this.$worklog.upload(t,s,1e3*o,r).then((t=>{e.disabled=!0,e.selected=!1,e.status="Uploaded",e.worklogId=t.id,this.setState((({worklogData:e})=>({worklogData:[...e]})))}),(t=>{const{message:s,response:o,status:r,error:{errors:i,errorMessages:l}={}}=t;e.disabled=!0,e.selected=!1,e.status=h;const a=i&&Object.keys(i);return s?e.error=s:null!==a&&void 0!==a&&a.length?e.error=a.reduce(((e,t)=>{const s=i[t];return e?`${e}; ${s}`:s}),""):null!==l&&void 0!==l&&l.length?e.error=l.reduce(((e,t)=>e?`${e}; ${t}`:t),""):(null===o||void 0===o?void 0:o.length)>5&&o.length<=100?e.error=o:r&&(e.error=`Status Code: ${r}`),this.setState((({worklogData:e})=>({worklogData:[...e]}))),Promise.resolve()}))}formatTimespent(e){return"number"===typeof e?this.$utils.formatSecs(e):e}renderFooter(){const{state:{autoUpload:e,isLoading:t,selectedCount:s}}=this;return(0,c.jsxs)("div",{className:"pnl-footer",children:[(0,c.jsx)("div",{className:"float-start",children:(0,c.jsx)(l.Sc,{checked:e,label:"Directly upload worklog to Jira",disabled:t,onChange:this.toggleAutoUpload})}),(0,c.jsxs)("div",{className:"float-end",children:[(0,c.jsx)(l.$n,{text:!0,type:"info",icon:"fa fa-list",label:"Clear",disabled:t,onClick:this.clearWorklogs}),(0,c.jsx)(l.$n,{type:"primary",icon:e?"fa fa-upload":"fa fa-save",disabled:t||!(s>0),label:e?`Upload ${s} worklogs`:`Import ${s} worklogs`,onClick:this.importWorklogs})]})]})}getWorklogLink(e){const{ticketNo:t,worklogId:s,status:o}=e;return(0,c.jsx)(n.A,{className:"link",href:this.$userutils.getWorklogUrl(t,s),children:o})}render(){const{worklogData:e,ticketSummary:t,selectAll:s}=this.state;return super.renderBase((0,c.jsx)("div",{className:"import-worklog",children:(0,c.jsxs)(o.ew,{dataset:e,className:"worklog-table",children:[(0,c.jsx)(o.D1,{children:(0,c.jsxs)(o.lO,{children:[(0,c.jsx)(o.VP,{children:(0,c.jsx)(l.Sc,{checked:s,onChange:this.toggleAllRows})}),(0,c.jsx)(o.VP,{sortBy:"ticketNo",children:"Ticket No"}),(0,c.jsx)(o.VP,{children:"Issue Type"}),(0,c.jsx)(o.VP,{children:"Summary"}),(0,c.jsx)(o.VP,{sortBy:"startDate",children:"Log Date"}),(0,c.jsx)(o.VP,{sortBy:"timespent",children:"Timespent"}),(0,c.jsx)(o.VP,{children:"Comment"}),(0,c.jsx)(o.VP,{children:"Assignee"}),(0,c.jsx)(o.VP,{sortBy:"status",children:"Status"})]})}),(0,c.jsx)(o.vc,{children:(e,s)=>{const o=t[e.ticketNo]||null,r=o||{summary:"Unavailable"};return(0,c.jsxs)("tr",{className:e.error?"row-error":"",children:[(0,c.jsx)("td",{children:(0,c.jsx)(l.Sc,{checked:e.selected,disabled:e.disabled,onChange:()=>this.toggleSelection(e,s)})}),o&&(0,c.jsx)("td",{children:this.getTicketLink(e.ticketNo)}),!o&&(0,c.jsx)("td",{children:e.ticketNo}),(0,c.jsxs)("td",{children:[r.issueTypeIcon&&(0,c.jsx)("img",{src:r.issueTypeIcon,alt:""})," ",r.issueType]}),(0,c.jsx)("td",{children:r.summary}),(0,c.jsx)("td",{children:this.formatDate(e.startDate)}),(0,c.jsx)("td",{children:this.formatTimespent(e.timespent)}),(0,c.jsx)("td",{children:e.comment}),(0,c.jsx)("td",{children:r.assignee}),e.worklogId&&(0,c.jsx)("td",{title:"Worklog uploaded successfully",children:this.getWorklogLink(e)}),!e.worklogId&&(0,c.jsxs)("td",{title:e.error,children:[e.error&&(0,c.jsx)("span",{className:"fa fa-exclamation-triangle msg-error"})," ",e.status]})]},s)}}),(0,c.jsxs)(o.QC,{span:9,children:["Upload the list of worklogs by clicking the ( ",(0,c.jsx)("span",{className:"fa fa-upload"})," ) icon in top right corner. Click ",(0,c.jsx)("span",{className:"link",onClick:this.downloadTemplate,children:"here"})," to download a sample template."]})]})}))}}const S=x}}]);